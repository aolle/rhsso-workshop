Red Hat Single Sign-On (RH-SSO) provides an **Authentication SPI** that can be used to implement custom authentication mechanisms. In this example, we will demonstrate a simple **two-factor authentication (2FA)** flow using RH-SSO and a Telegram bot.

The custom authenticator consists of three components:

* **Authenticator:** Prompts the user to enter the 2FA code provided via Telegram.
* **Required Action:** Provides an enrollment process if the user's Telegram ID is not present in their profile.
* **Telegram Service:** Handles communication with the external Telegram API.

[#auth-plugin-setup]
=== Configuring Plugins and Authentication Flows

The plugin implementation `telegram-authentication-spi` can be deployed in several ways:

* Extending the RH-SSO image.
* Mounting a volume with the plugin file.
* Using a configmap (recommended only for metadata).
* Copying the plugin into the pod (ephemeral).
* Other methods.

Steps to configure the authentication flow:

* Open the RH-SSO administration web console.
* Navigate to `Authentication` → `Flows`.
* Select `Browser` in the drop-down list and click `Copy`.

image::authentication/authentication-menu.png[]
image::authentication/copy-browser-flow.png[]

* Provide a name for the new browser flow.

image::authentication/new-browser-authentication-flow-name.png[]

* Click `Actions` → `Add execution`. Select `Browser With Telegram Browser - Conditional OTP`.

image::authentication/add-execution.png[]

* Choose **Telegram Authentication** and click `Save`.

image::authentication/telegram-authentication-exec.png[]

* Configure the execution:
  * `Browser With Telegram Browser - Conditional OTP` → REQUIRED
  * `OTP Form` → DISABLED
  * `Telegram Authentication` → REQUIRED

image::authentication/authentication-flow-cfg.png[]

* Click `Actions` → `Config` on `Telegram Authentication`. Set an alias and click `Save`.

image::authentication/telegram-authentication-action-config.png[]
image::authentication/telegram-authentication-config.png[]

* Navigate to `Authentication` → `Required Actions` → `Register`.
* Select **Telegram ID** in the drop-down list. Click `Ok`.

image::authentication/telegram-id-ra.png[]

* Bind the new flow:
  * Navigate to `Authentication` → `Bindings`.
  * Select **Browser with Telegram** in the `Browser Flow` drop-down list.
  * Click `Save`.

image::authentication/telegram-binding.png[]

[#telegram2fa]
=== Two-Factor Authentication with Telegram

* Open a new private/incognito browser session.
* Navigate to the Quarkus Petclinic application. You will be redirected to the RH-SSO login page.
* Log in as user `angel`.

image::authentication/user-first-login.png[]

Since this is the first login after 2FA setup, the **enrollment process** is triggered.

image::authentication/2fa-enroll.png[]

* Open Telegram and send the enrollment code to the bot. Submit the secure code received from the bot.

image::authentication/telegram-enroll.png[]
image::authentication/2fa-enrollment-code-submit.png[]

After successful enrollment, the user is logged in, and the Telegram attributes are added to the user profile.

* Verify the Telegram attributes in RH-SSO:
  * Navigate to `Demo` realm → `Users` → `View all users`.
  * Select user `angel` and click `Attributes`.

image::authentication/user-id.png[]
image::authentication/telegram-user-attributes.png[]

* Subsequent logins require the 2FA code:
  * Open a new incognito session.
  * Log in as `angel`. The 2FA code will be requested.

image::authentication/2fa-code-form.png[]

* The code is sent via Telegram bot. Submit the code.

image::authentication/2fa-telegram-code.png[]
image::authentication/submit-2fa.png[]

The user is successfully logged in to the application with 2FA enabled.
