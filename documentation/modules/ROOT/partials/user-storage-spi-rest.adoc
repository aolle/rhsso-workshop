We have an external system that stores and manages user data, accessible via a REST API.

However, due to certain constraints, we do not want to migrate this existing system to the Red Hat Single Sign-On (RH-SSO) data model.
Instead, we aim to integrate our RH-SSO deployment with this external user storage system.

The REST API is implemented using Quarkus and is named `jaxrs-user-store`. It provides two endpoints:

* `/api/v1/users` – returns all users in the system.
* `/api/v1/users/{id}` – returns the user matching the `userId` with `id`.

Both endpoints accept `GET` requests.

Deploying the application

The application is designed to run on OpenShift. You can deploy it by executing the `ocp-deploy.sh` script or, alternatively:

[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
./mvnw install -Dquarkus.kubernetes.deploy=true
----

Testing the application endpoints

[.lines_space]
[.console-output]
[source,bash, subs="+macros,+attributes"]
----
$ http ${APP_HOSTNAME}/api/v1/users

HTTP/1.1 200 OK
Content-Type: application/json
content-length: 731

[
<..>
    {
        "email": "abel@example.com",
        "firstName": "Abel",
        "lastName": "Miiii",
        "password": "abelpassword",
        "userId": "5",
        "username": "abel"
    },
    {
        "email": "mao@example.com",
        "firstName": "Mao",
        "lastName": "Meow",
        "password": "maopassword",
        "userId": "3",
        "username": "mao"
    }
<..>
]
----

[.lines_space]
[.console-output]
[source,bash, subs="+macros,+attributes"]
----
$ http localhost:8081/api/v1/users/1

HTTP/1.1 200 OK
Content-Type: application/json
content-length: 120

{
    "email": "nata@example.com",
    "firstName": "Nata",
    "lastName": "Natilla",
    "password": "natapassword",
    "userId": "1",
    "username": "nata"
}
----

Extending RH-SSO with the User Storage SPI

To connect RH-SSO to the external system, we use the `User Storage SPI` (`Service Provider Interface`).

The provider implementation is called `custom-user-storage-spi` and can be deployed using several methods:

* Extending the RH-SSO image.
* Mounting a volume with the JAR file.
* Using a ConfigMap (not recommended for large files; better for metadata only).
* Copying the JAR into the pod (ephemeral storage).
* Other deployment methods as required.

The provider reads the `USER_STORAGE_CUSTOM_SPI_TARGET_HOST` environment variable in the following format: `HOST:PORT` or just `HOST` (defaults to port 80).
This value can be provided in the `DeploymentConfig` environment variables.

Once the package is deployed and the environment variable is set, the new provider will appear in the RH-SSO admin console under `User Federation`.

* Click `demo-user-provider`.

image::federation/user-storage-spi-provider-listed.png[]

* Verify that the provider is `Enabled` and click `Save`.

image::federation/add-new-user-storage-spi.png[]

image::federation/custom-user-storage-spi-enabled.png[]

* Click `Users`. The external storage users should now be loaded into RH-SSO.

image::federation/users-loaded.png[]
